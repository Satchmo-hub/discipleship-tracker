name: Refresh Public Stats

on:
  schedule:
    - cron: "0 * * * *" # hourly (UTC)
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function (refresh-public-stats)
        env:
          FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL }}/refresh-public-stats
          SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîÅ Calling refresh-public-stats"
          echo "URL: $FUNCTION_URL"

          RESPONSE_FILE=$(mktemp)
          STATUS_CODE=$(curl -sS -X POST "$FUNCTION_URL" \
            -H "Authorization: Bearer $SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -w "%{http_code}" \
            -o "$RESPONSE_FILE")

          echo "HTTP Status: $STATUS_CODE"
          echo "Response:"
          cat "$RESPONSE_FILE"
          echo ""

          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "‚ùå refresh-public-stats failed"
            exit 1
          fi

          echo "‚úÖ refresh-public-stats succeeded"
